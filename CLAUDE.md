# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

```bash
# Development
npm run dev              # Start development server with Turbopack
npm run build           # Create production build
npm run start           # Start production server

# Testing
npm run test            # Run all tests
npm run test:watch      # Run tests in watch mode
npm run test:coverage   # Run tests with coverage report

# Code Quality
npm run lint            # Run ESLint on src/app directory
npm run lint:all        # Run Next.js linting
npm run type-check      # Run TypeScript type checking
```

## Architecture Overview

This is a **Next.js 15 App Router** application that creates AI-powered Spotify playlists using a **two-step process**:

### Core Flow

1. **Authentication**: Spotify OAuth with secure cookie-based session management
2. **AI Generation**: OpenAI GPT generates song recommendations based on user prompts
3. **Preview & Approval**: Users review AI suggestions before committing
4. **Spotify Integration**: Creates actual playlists in user's Spotify account

### Key Architecture Patterns

**API Routes Structure**:

- `/api/auth/*` - Spotify OAuth flow (login, callback, check, logout)
- `/api/generate-songs` - OpenAI integration for song generation with user session caching
- `/api/create-playlist` - Spotify Web API integration for playlist creation

**State Management**: Single-page React component (`page.tsx`) manages entire user flow with useState hooks for authentication, generation, and playlist creation states.

**Caching Strategy**: In-memory user session cache prevents AI from repeating songs within the same session. Uses Spotify access token suffix as user identifier with automatic cleanup.

**AI Personality Modes**: Five distinct AI personalities (default, mainstream, discovery, nostalgia, experimental) that modify OpenAI system prompts to influence music recommendations.

**Authentication Flow**:

- Spotify OAuth with `playlist-modify-public` scope
- HttpOnly cookies for token storage
- Automatic token validation on page focus/visibility change
- Graceful fallback for expired sessions

## Important Implementation Details

**OpenAI Integration**: Uses temperature 0.4 with specific JSON format requirements. Includes user session avoidance system that tells AI to avoid 20% overlap with previous generations for the same prompt type.

**Spotify API Integration**: Two-step process where songs are first generated by AI, then searched and added to Spotify. Handles partial matches and missing tracks gracefully.

**Error Handling**: Comprehensive error boundaries with user-friendly messages while protecting sensitive API details.

**Environment Variables Required**:

```
SPOTIFY_CLIENT_ID, SPOTIFY_CLIENT_SECRET, SPOTIFY_REDIRECT_URI
OPENAI_API_KEY
NEXTAUTH_URL, NEXTAUTH_SECRET
```

**Testing**: Jest + React Testing Library with mocked API calls. Tests cover authentication flow, song generation, playlist creation, and error states.

**Security**: Environment-based secrets, secure cookie handling, input validation, and no sensitive data exposure in client-side code.

## Documentation Research Guidelines

- When looking at documentation for Next.js, Tailwind.css, Jest, Jest Mocks you MUST use context7 MCP server to get information.

## Development Best Practices

- Before beginning work on a feature or issue, please ensure you are based off the development branch and all of the local code is up to date. Use git pull rebase instead of just the git pull to get code changes where applicable.

## Commit Message Guidelines

- Keep commit messages clear and concise and do not add unnecessary information such as information about claude or the developer.

## Security Guidelines

- NEVER commit .env files or other files with sensitive keys or secrets.

## Pull Request Guidelines

- All pull requests should be made to the development branch. Do not try to merge into main.
- NEVER push directly to development or main branches